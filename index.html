<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escape the Maze</title>
    <style>
        /* –¶–≤–µ—Ç–∞ */
        :root {
            --bg-color: #0a3d2e;
            --path-color: #1f4a35; /* –ù–æ–≤—ã–π: –°–ø–ª–æ—à–Ω–æ–π —Ü–≤–µ—Ç –¥–ª—è –ø—É—Ç–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ */
            --wall-color: #0d2821; /* –ù–æ–≤—ã–π: –°–ø–ª–æ—à–Ω–æ–π —Ü–≤–µ—Ç –¥–ª—è —Å—Ç–µ–Ω (–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —è—á–µ–µ–∫) */
            --panel-color: rgba(20, 60, 45, 0.85);
            --player-color: #4ade80;
            --goal-color: #fbbf24;
            --key-color: #fb7185;
            --enemy-color: #dc2626;
            --text-color: #ecfdf5;
            --border-color: #065f46;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            /* –§–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ */
            background: url('https://i.imgur.com/LK13C7U.png') no-repeat center center fixed;
            background-size: cover;
            position: relative;
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-color: rgba(10, 61, 46, 0.7);
        }

        .container {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 10px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 5px;
            color: var(--key-color);
            text-shadow: 0 0 20px rgba(251, 113, 133, 0.6), 0 2px 4px rgba(0,0,0,0.3);
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            background-color: var(--panel-color);
            padding: 15px;
            border-radius: 15px;
            border: 2px solid var(--border-color);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .stats {
            display: flex;
            gap: 20px;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .keys-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .keys-label {
            font-weight: bold;
        }

        .keys-icons {
            display: flex;
            gap: 5px;
        }

        .key-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--key-color);
            opacity: 0.3;
            transition: opacity 0.3s;
        }

        .key-icon.collected {
            opacity: 1;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        button {
            background: linear-gradient(135deg, var(--player-color), #22c55e);
            color: #0a3d2e;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(74, 222, 128, 0.3);
            touch-action: manipulation;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(74, 222, 128, 0.5);
        }

        .game-area {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1;
            max-width: 600px;
        }

        canvas {
            width: 100%;
            height: 100%;
            /* –£–î–ê–õ–ï–ù –ì–†–ê–î–ò–ï–ù–¢, —Ñ–æ–Ω –±—É–¥–µ—Ç –∑–∞–¥–∞–Ω –≤ JS –∫–∞–∫ —Å–ø–ª–æ—à–Ω–æ–π */
            background-color: var(--path-color); 
            border-radius: 15px;
            border: 3px solid var(--border-color);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            touch-action: none;
        }

        .mobile-controls {
            display: none;
            width: 100%;
            max-width: 600px;
            gap: 20px;
            margin-top: 10px;
        }

        .joystick-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .joystick {
            width: 120px;
            height: 120px;
            background: var(--panel-color);
            border-radius: 50%;
            border: 3px solid var(--border-color);
            position: relative;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            touch-action: none;
        }

        .joystick-handle {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--player-color), #22c55e);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: transform 0.1s;
            box-shadow: 0 4px 12px rgba(74, 222, 128, 0.4);
        }

        .dpad-container {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 8px;
            max-width: 150px;
            margin: 0 auto;
        }

        .dpad-btn {
            background: var(--panel-color);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--text-color);
            cursor: pointer;
            user-select: none;
            backdrop-filter: blur(10px);
            transition: all 0.1s;
            touch-action: manipulation;
            min-height: 50px;
        }

        .dpad-btn:active {
            background: linear-gradient(135deg, var(--player-color), #22c55e);
            transform: scale(0.95);
        }

        .dpad-up {
            grid-column: 2;
            grid-row: 1;
        }

        .dpad-right {
            grid-column: 3;
            grid-row: 2;
        }

        .dpad-down {
            grid-column: 2;
            grid-row: 3;
        }

        .dpad-left {
            grid-column: 1;
            grid-row: 2;
        }

        .dpad-center {
            grid-column: 2;
            grid-row: 2;
            background: transparent;
            border: none;
        }

        .instructions {
            background-color: var(--panel-color);
            padding: 15px;
            border-radius: 15px;
            border: 2px solid var(--border-color);
            width: 100%;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .instructions h2 {
            margin-bottom: 10px;
            color: var(--key-color);
        }

        .instructions p {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(20, 60, 45, 0.98), rgba(13, 92, 66, 0.98));
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            border: 3px solid var(--key-color);
            box-shadow: 0 0 40px rgba(251, 113, 133, 0.4);
            backdrop-filter: blur(10px);
        }

        .modal h2 {
            margin-bottom: 20px;
            color: var(--key-color);
            text-shadow: 0 0 15px rgba(251, 113, 133, 0.5);
        }

        .modal p {
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .question {
            font-size: 1.2rem;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .option-btn {
            background-color: rgba(10, 61, 46, 0.8);
            color: var(--text-color);
            padding: 12px;
            border-radius: 10px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s;
            touch-action: manipulation;
        }

        .option-btn:active {
            background: linear-gradient(135deg, var(--player-color), #22c55e);
            color: var(--bg-color);
            border-color: var(--player-color);
            transform: translateX(5px);
        }

        .win-message {
            color: var(--goal-color);
            font-weight: bold;
            font-size: 1.3rem;
            margin-bottom: 20px;
        }

        /* –ê–î–ê–ü–¢–ê–¶–ò–Ø –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–• –£–°–¢–†–û–ô–°–¢–í */
        @media (min-width: 769px) {
            /* –°–∫—Ä—ã–≤–∞–µ–º –º–æ–±–∏–ª—å–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª—ã –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
            .mobile-controls {
                display: none !important;
            }
        }
        
        @media (max-width: 768px) {
            .game-info {
                flex-direction: column;
                gap: 15px;
            }
            
            .controls {
                justify-content: center;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .mobile-controls {
                /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–±–∏–ª—å–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª—ã */
                display: flex;
            }
            
            .joystick {
                width: 100px;
                height: 100px;
            }
            
            .joystick-handle {
                width: 40px;
                height: 40px;
            }
            
            .dpad-container {
                max-width: 130px;
            }
            
            .dpad-btn {
                font-size: 1.2rem;
                min-height: 45px;
            }
        }

        @media (max-width: 480px) {
            .mobile-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .joystick-container, .dpad-container {
                width: 100%;
            }
            
            .dpad-container {
                max-width: 200px;
            }
            
            .dpad-btn {
                height: 60px;
                font-size: 1.5rem;
            }
            
            h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üå¥ Escape the Maze üå¥</h1>
        </header>
        
        <div class="game-info">
            <div class="stats">
                <div class="stat">
                    <div class="stat-label">–í–†–ï–ú–Ø</div>
                    <div class="stat-value" id="timer">00:00.0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">–®–ê–ì–ò</div>
                    <div class="stat-value" id="steps">0</div>
                </div>
            </div>
            
            <div class="keys-container">
                <div class="keys-label">–ö–ª—é—á–∏:</div>
                <div class="keys-icons" id="keys-icons"></div>
            </div>
            
            <div class="controls">
                <button id="new-maze">–ù–æ–≤—ã–π –õ–∞–±–∏—Ä–∏–Ω—Ç</button>
                <button id="replay">–ü–æ–≤—Ç–æ—Ä</button>
            </div>
        </div>
        
        <div class="game-area">
            <canvas id="maze-canvas"></canvas>
        </div>
        
        <div class="mobile-controls">
            <div class="joystick-container">
                <div class="joystick" id="joystick">
                    <div class="joystick-handle" id="joystick-handle"></div>
                </div>
                <div>–î–∂–æ–π—Å—Ç–∏–∫</div>
            </div>
            
            <div class="dpad-container">
                <div class="dpad-btn dpad-up" data-direction="up">‚Üë</div>
                <div class="dpad-btn dpad-right" data-direction="right">‚Üí</div>
                <div class="dpad-btn dpad-down" data-direction="down">‚Üì</div>
                <div class="dpad-btn dpad-left" data-direction="left">‚Üê</div>
                <div class="dpad-center"></div>
            </div>
        </div>
        
        <div class="instructions">
            <h2>–ö–∞–∫ –ò–≥—Ä–∞—Ç—å</h2>
            <p>‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ <strong>WASD</strong> –∏–ª–∏ <strong>–°—Ç—Ä–µ–ª–∫–∏</strong> –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è (–¥–µ—Å–∫—Ç–æ–ø)</p>
            <p>‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ <strong>–î–∂–æ–π—Å—Ç–∏–∫</strong> –∏–ª–∏ <strong>D-Pad</strong> –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è (–º–æ–±–∏–ª—å–Ω—ã–π)</p>
            <p>‚Ä¢ –°–æ–±–µ—Ä–∏—Ç–µ –≤—Å–µ 10 –∫–ª—é—á–µ–π, –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–≤–µ—Ç–∏–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã</p>
            <p>‚Ä¢ –ò–∑–±–µ–≥–∞–π—Ç–µ –≤—Ä–∞–≥–æ–≤ –ø–æ—Å–ª–µ —Å–±–æ—Ä–∞ –≤—Å–µ—Ö –∫–ª—é—á–µ–π</p>
            <p>‚Ä¢ –ù–∞–π–¥–∏—Ç–µ –≤—ã—Ö–æ–¥, —á—Ç–æ–±—ã –ø–æ–±–µ–¥–∏—Ç—å!</p>
        </div>
    </div>
    
    <div class="modal" id="question-modal">
        <div class="modal-content">
            <h2>üå∫ –ù–∞–π–¥–µ–Ω –ö–ª—é—á! üå∫</h2>
            <p>–û—Ç–≤–µ—Ç—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, —á—Ç–æ–±—ã –∑–∞–±—Ä–∞—Ç—å –∫–ª—é—á:</p>
            <div class="question" id="question-text"></div>
            <div class="options" id="options-container"></div>
        </div>
    </div>
    
    <div class="modal" id="win-modal">
        <div class="modal-content">
            <h2>üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! üéâ</h2>
            <div class="win-message">‚≠ê –í—ã —Å–±–µ–∂–∞–ª–∏! ‚≠ê</div>
            <p>–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç –∑–∞ <span id="win-time">00:00.0</span>, —Å–¥–µ–ª–∞–≤ <span id="win-steps">0</span> —à–∞–≥–æ–≤!</p>
            <button id="play-again">–ò–≥—Ä–∞—Ç—å –°–Ω–æ–≤–∞</button>
        </div>
    </div>

    <script>
        const MAZE_SIZE = 25;
        const PLAYER_RADIUS = 10;
        const KEY_RADIUS = 8;
        const EXIT_RADIUS = 12;
        const ENEMY_RADIUS = 10;
        const TOTAL_KEYS = 10;
        const TOTAL_ENEMIES = 5;
        const ENEMY_MOVE_CHANCE = 0.3;

        // –ü–æ–ª—É—á–∞–µ–º —Ü–≤–µ—Ç–∞ –∏–∑ CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
        const PATH_COLOR = getComputedStyle(document.documentElement).getPropertyValue('--path-color').trim();
        const WALL_COLOR = getComputedStyle(document.documentElement).getPropertyValue('--wall-color').trim();
        
        let maze = [];
        let player = { x: 1, y: 1 };
        let keys = [];
        let collectedKeys = 0;
        let exit = null;
        let enemies = [];
        let steps = 0;
        let startTime = null;
        let timerInterval = null;
        let gameRunning = false;
        let allKeysCollected = false;
        
        // Mobile control variables
        let joystickActive = false;
        let moveInterval = null;
        let currentDirection = { x: 0, y: 0 };
        // isMobile –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ CSS
        
        const canvas = document.getElementById('maze-canvas');
        const ctx = canvas.getContext('2d');

        // –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤
        const questionsData = [
            "The fast-flowing river ___ into the sea every day.,flows,is flowing,flow,1",
            "Look! The dense forest ___ because of the strong wind right now.,is moving,moves,moving,1",
            "We usually ___ on the sandy beach in the morning.,are lying,lie,lies,2",
            "Shhh! The active volcano ___! Go go go!,erupts,is erupting,erupt,2",
            "The quiet town ___ much traffic even on weekdays.,doesn't have,isn't having,don't have,1",
            "Listen! Someone ___ a boat on the deep lake at the moment.,sail,is sailing,sails,2",
            "They ___ a big mountain in the Himalayas every year.,are climbing,climbs,climb,3",
            "Why ___ the children ___ to the city centre today?,is...going,do...go,are...going,3",
            "The sun always ___ the hot desert during the day.,is heating,heats,heat,2",
            "Right now I ___ the sea view from my tropical island balcony.,am enjoying,enjoy,enjoys,1",
            "That spectacular waterfall ___ a lot of water in spring.,is having,has,have,2",
            "Be careful! You ___ through the dense forest right now.,walk,are walking,walking,2",
            "My family ___ on a small island this summer.,are living,live,is living,1",
            "He never ___ to climb a volcano because he is afraid.,tries,is trying,try,1",
            "Look the tide ___ in so we must leave the beach!,comes,is coming,come,2",
            "Tourists often ___ down the river on a big boat.,are sailing,sails,sail,3",
            "I ___ the city life right now but I usually prefer the quiet town.,don't enjoy,am not enjoying,doesn't enjoy,2",
            "Every morning the children ___ to the river bank to watch the birds.,are going,goes,go,3",
            "My brother ___ on the sandy beach at the moment.,lies,is lying,is lieing,2",
            "Where ___ the vast desert ___ the small country?,is...crossing,does...cross,do...cross,2"
        ];

        const questions = questionsData.map(q => {
            const parts = q.split(',');
            return {
                question: parts[0],
                options: [parts[1], parts[2], parts[3]],
                correct: parseInt(parts[4]) - 1
            };
        });

        function initGame() {
            player = { x: 1, y: 1 };
            keys = [];
            collectedKeys = 0;
            exit = null;
            enemies = [];
            steps = 0;
            allKeysCollected = false;
            joystickActive = false;
            currentDirection = { x: 0, y: 0 };
            
            document.getElementById('steps').textContent = '0';
            document.getElementById('timer').textContent = '00:00.0';
            updateKeyIcons();
            resetJoystick();
            
            generateMaze();
            placeKeys();
            
            if (timerInterval) clearInterval(timerInterval);
            if (moveInterval) clearInterval(moveInterval);
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 100);
            
            gameRunning = true;
            drawMaze();
        }

        function generateMaze() {
            maze = Array(MAZE_SIZE).fill().map(() => Array(MAZE_SIZE).fill(1));
            
            const stack = [{x: 1, y: 1}];
            maze[1][1] = 0;
            
            const directions = [
                {dx: 0, dy: -2},
                {dx: 2, dy: 0},
                {dx: 0, dy: 2},
                {dx: -2, dy: 0}
            ];
            
            while (stack.length > 0) {
                const current = stack[stack.length - 1];
                const neighbors = [];
                
                for (const dir of directions) {
                    const nx = current.x + dir.dx;
                    const ny = current.y + dir.dy;
                    
                    if (nx > 0 && nx < MAZE_SIZE - 1 && ny > 0 && ny < MAZE_SIZE - 1 && maze[ny][nx] === 1) {
                        neighbors.push({x: nx, y: ny, dir: dir});
                    }
                }
                
                if (neighbors.length > 0) {
                    const randomNeighbor = neighbors[Math.floor(Math.random() * neighbors.length)];
                    maze[current.y + randomNeighbor.dir.dy/2][current.x + randomNeighbor.dir.dx/2] = 0;
                    maze[randomNeighbor.y][randomNeighbor.x] = 0;
                    stack.push({x: randomNeighbor.x, y: randomNeighbor.y});
                } else {
                    stack.pop();
                }
            }
            
            maze[1][1] = 0;
            maze[MAZE_SIZE-2][MAZE_SIZE-2] = 0;
        }

        function placeKeys() {
            keys = [];
            for (let i = 0; i < TOTAL_KEYS; i++) {
                let keyPlaced = false;
                while (!keyPlaced) {
                    const x = Math.floor(Math.random() * (MAZE_SIZE - 2)) + 1;
                    const y = Math.floor(Math.random() * (MAZE_SIZE - 2)) + 1;
                    
                    if (maze[y][x] === 0 && (Math.abs(x - player.x) > 3 || Math.abs(y - player.y) > 3)) {
                        keys.push({x, y, collected: false});
                        keyPlaced = true;
                    }
                }
            }
        }

        function updateKeyIcons() {
            const keysIcons = document.getElementById('keys-icons');
            keysIcons.innerHTML = '';
            
            for (let i = 0; i < TOTAL_KEYS; i++) {
                const keyIcon = document.createElement('div');
                keyIcon.className = `key-icon ${i < collectedKeys ? 'collected' : ''}`;
                keysIcons.appendChild(keyIcon);
            }
        }

        function drawMaze() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const cellWidth = canvas.width / MAZE_SIZE;
            const cellHeight = canvas.height / MAZE_SIZE;
            
            /* –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–±—Ä–∞–Ω –≥—Ä–∞–¥–∏–µ–Ω—Ç. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–ø–ª–æ—à–Ω–æ–π —Ü–≤–µ—Ç —Å—Ç–µ–Ω—ã. */
            ctx.fillStyle = WALL_COLOR;
            
            for (let y = 0; y < MAZE_SIZE; y++) {
                for (let x = 0; x < MAZE_SIZE; x++) {
                    // –Ø—á–µ–π–∫–∏ —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º 1 - —ç—Ç–æ —Å—Ç–µ–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –º—ã —Ä–∏—Å—É–µ–º
                    if (maze[y][x] === 1) {
                        ctx.fillRect(x * cellWidth, y * cellHeight, cellWidth, cellHeight);
                    }
                    // –Ø—á–µ–π–∫–∏ —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º 0 - —ç—Ç–æ –ø—É—Ç–∏, –æ–Ω–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ü–≤–µ—Ç–æ–º —Ñ–æ–Ω–∞ canvas (PATH_COLOR –∏–∑ CSS)
                }
            }
            /* –ö–æ–Ω–µ—Ü –∏–∑–º–µ–Ω–µ–Ω–∏—è */
            
            ctx.fillStyle = '#fb7185';
            ctx.shadowColor = '#fb7185';
            ctx.shadowBlur = 10;
            for (const key of keys) {
                if (!key.collected) {
                    ctx.beginPath();
                    ctx.arc(
                        (key.x + 0.5) * cellWidth,
                        (key.y + 0.5) * cellHeight,
                        KEY_RADIUS,
                        0,
                        Math.PI * 2
                    );
                    ctx.fill();
                }
            }
            ctx.shadowBlur = 0;
            
            if (allKeysCollected && exit) {
                ctx.fillStyle = '#fbbf24';
                ctx.shadowColor = '#fbbf24';
                ctx.shadowBlur = 15;
                ctx.beginPath();
                ctx.arc(
                    (exit.x + 0.5) * cellWidth,
                    (exit.y + 0.5) * cellHeight,
                    EXIT_RADIUS,
                    0,
                    Math.PI * 2
                );
                ctx.fill();
                ctx.shadowBlur = 0;
                
                ctx.fillStyle = '#dc2626';
                ctx.shadowColor = '#dc2626';
                ctx.shadowBlur = 10;
                for (const enemy of enemies) {
                    ctx.beginPath();
                    ctx.arc(
                        (enemy.x + 0.5) * cellWidth,
                        (enemy.y + 0.5) * cellHeight,
                        ENEMY_RADIUS,
                        0,
                        Math.PI * 2
                    );
                    ctx.fill();
                }
                ctx.shadowBlur = 0;
            }
            
            ctx.shadowColor = '#4ade80';
            ctx.shadowBlur = 20;
            ctx.fillStyle = '#4ade80';
            ctx.beginPath();
            ctx.arc(
                (player.x + 0.5) * cellWidth,
                (player.y + 0.5) * cellHeight,
                PLAYER_RADIUS,
                0,
                Math.PI * 2
            );
            ctx.fill();
            ctx.shadowBlur = 0;
        }

        function movePlayer(dx, dy) {
            if (!gameRunning) return;
            
            const newX = player.x + dx;
            const newY = player.y + dy;
            
            if (newX >= 0 && newX < MAZE_SIZE && newY >= 0 && newY < MAZE_SIZE && maze[newY][newX] === 0) {
                player.x = newX;
                player.y = newY;
                steps++;
                document.getElementById('steps').textContent = steps;
                
                checkKeyCollection();
                
                if (allKeysCollected) {
                    checkExit();
                    checkEnemyCollision();
                    moveEnemies();
                }
                
                drawMaze();
            }
        }

        function checkKeyCollection() {
            for (let i = 0; i < keys.length; i++) {
                const key = keys[i];
                if (!key.collected && player.x === key.x && player.y === key.y) {
                    showQuestionModal(i);
                    break;
                }
            }
        }

        function showQuestionModal(keyIndex) {
            const modal = document.getElementById('question-modal');
            const questionText = document.getElementById('question-text');
            const optionsContainer = document.getElementById('options-container');
            
            const randomQuestion = questions[Math.floor(Math.random() * questions.length)];
            
            questionText.textContent = randomQuestion.question;
            
            optionsContainer.innerHTML = '';
            randomQuestion.options.forEach((option, index) => {
                const optionBtn = document.createElement('button');
                optionBtn.className = 'option-btn';
                optionBtn.textContent = option;
                optionBtn.onclick = () => checkAnswer(keyIndex, index, randomQuestion.correct);
                optionsContainer.appendChild(optionBtn);
            });
            
            modal.style.display = 'flex';
        }

        function checkAnswer(keyIndex, selectedIndex, correctIndex) {
            const modal = document.getElementById('question-modal');
            modal.style.display = 'none';
            
            if (selectedIndex === correctIndex) {
                keys[keyIndex].collected = true;
                collectedKeys++;
                updateKeyIcons();
                
                if (collectedKeys === TOTAL_KEYS) {
                    allKeysCollected = true;
                    placeExitAndEnemies();
                }
            } else {
                let keyPlaced = false;
                while (!keyPlaced) {
                    const x = Math.floor(Math.random() * (MAZE_SIZE - 2)) + 1;
                    const y = Math.floor(Math.random() * (MAZE_SIZE - 2)) + 1;
                    
                    if (maze[y][x] === 0 && !(x === player.x && y === player.y)) {
                        keys[keyIndex].x = x;
                        keys[keyIndex].y = y;
                        keyPlaced = true;
                    }
                }
            }
            
            drawMaze();
        }

        function placeExitAndEnemies() {
            let exitPlaced = false;
            while (!exitPlaced) {
                const x = Math.floor(Math.random() * (MAZE_SIZE - 2)) + 1;
                const y = Math.floor(Math.random() * (MAZE_SIZE - 2)) + 1;
                
                if (maze[y][x] === 0 && !(x === player.x && y === player.y)) {
                    exit = {x, y};
                    exitPlaced = true;
                }
            }
            
            enemies = [];
            for (let i = 0; i < TOTAL_ENEMIES; i++) {
                let enemyPlaced = false;
                while (!enemyPlaced) {
                    const x = Math.floor(Math.random() * (MAZE_SIZE - 2)) + 1;
                    const y = Math.floor(Math.random() * (MAZE_SIZE - 2)) + 1;
                    
                    if (maze[y][x] === 0 && 
                        !(x === player.x && y === player.y) &&
                        !(x === exit.x && y === exit.y)) {
                        enemies.push({x, y});
                        enemyPlaced = true;
                    }
                }
            }
            
            drawMaze();
        }

        function moveEnemies() {
            const directions = [
                {dx: 0, dy: -1},
                {dx: 1, dy: 0},
                {dx: 0, dy: 1},
                {dx: -1, dy: 0}
            ];
            
            for (const enemy of enemies) {
                if (Math.random() < ENEMY_MOVE_CHANCE) {
                    const randomDir = directions[Math.floor(Math.random() * directions.length)];
                    const newX = enemy.x + randomDir.dx;
                    const newY = enemy.y + randomDir.dy;
                    
                    if (newX >= 0 && newX < MAZE_SIZE && newY >= 0 && newY < MAZE_SIZE && maze[newY][newX] === 0) {
                        enemy.x = newX;
                        enemy.y = newY;
                    }
                }
            }
        }

        function checkEnemyCollision() {
            for (const enemy of enemies) {
                if (player.x === enemy.x && player.y === enemy.y) {
                    // –¢–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤—ã—Ö–æ–¥ –≤ —Å–ª—É—á–∞–π–Ω–æ–µ –º–µ—Å—Ç–æ
                    let exitPlaced = false;
                    while (!exitPlaced) {
                        const x = Math.floor(Math.random() * (MAZE_SIZE - 2)) + 1;
                        const y = Math.floor(Math.random() * (MAZE_SIZE - 2)) + 1;
                        
                        if (maze[y][x] === 0 && !(x === player.x && y === player.y)) {
                            exit.x = x;
                            exit.y = y;
                            exitPlaced = true;
                        }
                    }
                    break;
                }
            }
        }

        function checkExit() {
            if (allKeysCollected && exit && player.x === exit.x && player.y === exit.y) {
                gameRunning = false;
                clearInterval(timerInterval);
                if (moveInterval) clearInterval(moveInterval);
                
                const modal = document.getElementById('win-modal');
                document.getElementById('win-time').textContent = document.getElementById('timer').textContent;
                document.getElementById('win-steps').textContent = steps;
                modal.style.display = 'flex';
            }
        }

        function updateTimer() {
            if (!gameRunning) return;
            
            const currentTime = Date.now();
            const elapsedTime = currentTime - startTime;
            const minutes = Math.floor(elapsedTime / 60000);
            const seconds = Math.floor((elapsedTime % 60000) / 1000);
            const milliseconds = Math.floor((elapsedTime % 1000) / 100);
            
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${milliseconds}`;
        }

        // Mobile Controls
        function initMobileControls() {
            const joystick = document.getElementById('joystick');
            const joystickHandle = document.getElementById('joystick-handle');
            const dpadButtons = document.querySelectorAll('.dpad-btn[data-direction]');
            
            // Joystick events
            joystick.addEventListener('touchstart', handleJoystickStart);
            document.addEventListener('touchmove', handleJoystickMove);
            document.addEventListener('touchend', handleJoystickEnd);
            
            // D-Pad events
            dpadButtons.forEach(btn => {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º touchstart/touchend –¥–ª—è D-Pad –¥–ª—è –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è
                let currentTimeout;
                
                const startMove = (e) => {
                    e.preventDefault();
                    const direction = btn.dataset.direction;
                    handleDpadPress(direction);
                };

                const endMove = (e) => {
                    e.preventDefault();
                    stopContinuousMove();
                };

                btn.addEventListener('touchstart', startMove);
                btn.addEventListener('touchend', endMove);
                
                // –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –º—ã—à—å—é –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
                btn.addEventListener('mousedown', startMove);
                btn.addEventListener('mouseup', endMove);
                btn.addEventListener('mouseleave', () => { 
                    if (currentDirection.x !== 0 || currentDirection.y !== 0) stopContinuousMove();
                });
            });
        }

        function handleJoystickStart(e) {
            e.preventDefault();
            joystickActive = true;
            // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –º—ã –±–µ—Ä–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–º–µ–Ω–Ω–æ –∏–∑ –æ–±–ª–∞—Å—Ç–∏ –¥–∂–æ–π—Å—Ç–∏–∫–∞
            updateJoystickPosition(e);
        }

        function handleJoystickMove(e) {
            if (!joystickActive) return;
            e.preventDefault();
            updateJoystickPosition(e);
        }

        function handleJoystickEnd(e) {
            // –ï—Å–ª–∏ touchend –ø—Ä–æ–∏–∑–æ—à–µ–ª –Ω–∞ –¥—Ä—É–≥–æ–º —ç–ª–µ–º–µ–Ω—Ç–µ, —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–Ω –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω
            if (!joystickActive) return; 
            
            joystickActive = false;
            resetJoystick();
            stopContinuousMove();
        }

        function updateJoystickPosition(e) {
            const joystick = document.getElementById('joystick');
            const joystickHandle = document.getElementById('joystick-handle');
            const rect = joystick.getBoundingClientRect();
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            
            const touch = e.touches[0];
            
            // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∞ –¥–∂–æ–π—Å—Ç–∏–∫–∞
            let deltaX = touch.clientX - (rect.left + centerX);
            let deltaY = touch.clientY - (rect.top + centerY);

            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            const maxDistance = rect.width / 3;
            
            let moveX = 0;
            let moveY = 0;
            
            if (distance > 10) {
                const angle = Math.atan2(deltaY, deltaX);
                const limitedDistance = Math.min(distance, maxDistance);
                
                const handleX = Math.cos(angle) * limitedDistance;
                const handleY = Math.sin(angle) * limitedDistance;
                
                // –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ –ø—Ä–æ—Ü–µ–Ω—Ç—ã –¥–ª—è CSS transform: translate
                const handlePercentX = (handleX / centerX) * 50;
                const handlePercentY = (handleY / centerY) * 50;

                joystickHandle.style.transform = `translate(${handlePercentX}%, ${handlePercentY}%)`;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ –ø–æ –æ—Å—è–º (–æ—Å–Ω–æ–≤–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
                if (Math.abs(deltaX) > Math.abs(deltaY) * 1.5) { // –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
                    moveX = deltaX > 0 ? 1 : -1;
                    moveY = 0;
                } else if (Math.abs(deltaY) > Math.abs(deltaX) * 1.5) { // –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏
                    moveY = deltaY > 0 ? 1 : -1;
                    moveX = 0;
                }
                // –ï—Å–ª–∏ –¥–≤–∏–∂–µ–Ω–∏–µ –Ω–µ —Å–∏–ª—å–Ω–æ–µ –≤ –æ–¥–Ω—É —Å—Ç–æ—Ä–æ–Ω—É, –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–ª–∏ 0,0
                
            } else {
                // –ï—Å–ª–∏ –∫–∞—Å–∞–Ω–∏–µ –±–ª–∏–∑–∫–æ –∫ —Ü–µ–Ω—Ç—Ä—É
                joystickHandle.style.transform = 'translate(-50%, -50%)';
            }
            
            // –ï—Å–ª–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å, –æ–±–Ω–æ–≤–ª—è–µ–º –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ
            if (currentDirection.x !== moveX || currentDirection.y !== moveY) {
                currentDirection = { x: moveX, y: moveY };
                startContinuousMove();
            }
        }

        function resetJoystick() {
            const joystickHandle = document.getElementById('joystick-handle');
            joystickHandle.style.transform = 'translate(-50%, -50%)';
            currentDirection = { x: 0, y: 0 };
        }

        function handleDpadPress(direction) {
            let dx = 0, dy = 0;
            
            switch (direction) {
                case 'up': dy = -1; break;
                case 'right': dx = 1; break;
                case 'down': dy = 1; break;
                case 'left': dx = -1; break;
            }
            
            currentDirection = { x: dx, y: dy };
            startContinuousMove();
        }

        function startContinuousMove() {
            if (moveInterval) clearInterval(moveInterval);
            
            // –°—Ä–∞–∑—É –¥–µ–ª–∞–µ–º –æ–¥–∏–Ω —à–∞–≥
            if (currentDirection.x !== 0 || currentDirection.y !== 0) {
                movePlayer(currentDirection.x, currentDirection.y);
            }
            
            // –ó–∞—Ç–µ–º –Ω–∞—á–∏–Ω–∞–µ–º –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ
            moveInterval = setInterval(() => {
                if (gameRunning && (currentDirection.x !== 0 || currentDirection.y !== 0)) {
                    movePlayer(currentDirection.x, currentDirection.y);
                } else {
                    stopContinuousMove(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º, –µ—Å–ª–∏ –Ω–µ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                }
            }, 200);
        }

        function stopContinuousMove() {
            if (moveInterval) {
                clearInterval(moveInterval);
                moveInterval = null;
            }
            // currentDirection –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º, —á—Ç–æ–±—ã –¥–∂–æ–π—Å—Ç–∏–∫ –º–æ–≥ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å
            // resetJoystick() —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç currentDirection –¥–ª—è –¥–∂–æ–π—Å—Ç–∏–∫–∞
        }

        function handleKeyDown(e) {
            if (!gameRunning) return;
            
            const key = e.key.toLowerCase();
            
            if (key === 'arrowup' || key === 'w') {
                e.preventDefault();
                movePlayer(0, -1);
            } else if (key === 'arrowright' || key === 'd') {
                e.preventDefault();
                movePlayer(1, 0);
            } else if (key === 'arrowdown' || key === 's') {
                e.preventDefault();
                movePlayer(0, 1);
            } else if (key === 'arrowleft' || key === 'a') {
                e.preventDefault();
                movePlayer(-1, 0);
            }
        }

        /**
         * –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ö–æ–ª—Å—Ç–∞
         */
        function initCanvas() {
            const gameArea = document.querySelector('.game-area');
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä —Ö–æ–ª—Å—Ç–∞ –ø–æ —à–∏—Ä–∏–Ω–µ —Ä–æ–¥–∏—Ç–µ–ª—è –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏
            const width = gameArea.clientWidth; 
            canvas.width = width;
            canvas.height = width;
        }

        // Initialize everything
        document.getElementById('new-maze').addEventListener('click', initGame);
        document.getElementById('replay').addEventListener('click', initGame);
        document.getElementById('play-again').addEventListener('click', () => {
            document.getElementById('win-modal').style.display = 'none';
            initGame();
        });
        
        document.addEventListener('keydown', handleKeyDown);
        window.addEventListener('resize', () => {
            // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞, –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
            initCanvas(); 
            drawMaze();
        });

        // Initialize mobile controls
        initMobileControls();
        initCanvas();
        initGame();
    </script>
</body>
</html>
